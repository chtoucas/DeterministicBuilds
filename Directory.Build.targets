<Project>

  <!-- Workaround for https://github.com/dotnet/sourcelink/issues/572 -->
  <!--
  <PropertyGroup>
    <TargetFrameworkMonikerAssemblyAttributesPath>$([System.IO.Path]::Combine('$(IntermediateOutputPath)','$(TargetFrameworkMoniker).AssemblyAttributes$(DefaultLanguageSourceExtension)'))</TargetFrameworkMonikerAssemblyAttributesPath>
  </PropertyGroup>
  <ItemGroup>
    <EmbeddedFiles Include="$(GeneratedAssemblyInfoFile)"/>
  </ItemGroup>
  -->

  <!-- Workaround for https://github.com/dotnet/sdk/issues/11105 -->
  <!--
  <ItemGroup>
    <SourceRoot Include="$(NuGetPackageRoot)" Condition=" '$(NuGetPackageRoot)' != '' " />
  </ItemGroup>
  -->

  <ItemGroup Condition=" '$(EnableSourceLink)' == 'false' and '$(ContinuousIntegrationBuild)' == 'true' ">
    <!--
      If we don't import "Microsoft.SourceLink.GitHub", a build will fail
      complaining about "SourceRoot".

      Deterministic = true (default) and ContinuousIntegrationBuild = true imply
      DeterministicSourcePaths = true.
      https://github.com/dotnet/roslyn/blob/master/src/Compilers/Core/MSBuildTask/Microsoft.Managed.Core.targets#L131
    -->
    <SourceRoot Include="$(RepositoryRoot)"/>
  </ItemGroup>

  <ItemGroup Condition=" '$(EnableSourceLink)' == 'true' ">
    <PackageReference Include="Microsoft.SourceLink.GitHub" Version="1.0.0" PrivateAssets="All" />
  </ItemGroup>

  <!-- https://github.com/coverlet-coverage/coverlet/blob/master/Documentation/DeterministicBuild.md -->
  <!--
    With UseSourceLink = false.
      Coverlet works fine but, of course, with local paths.
    With UseSourceLink = true.
      If we don't add this target, we get an empty CC.
      If we add it, Coverlet throws KeyNotFoundException.
   -->
  <Target Name="CoverletGetPathMap"
          DependsOnTargets="InitializeSourceRootMappedPaths"
          Returns="@(_LocalTopLevelSourceRoot)"
          Condition=" '$(DeterministicSourcePaths)' == 'true' ">

    <Message Text="In CoverletGetPathMap:" Importance="high" />
    <Message Text="- ContinuousIntegrationBuild      = $(ContinuousIntegrationBuild)" Importance="high" />
    <Message Text="- Deterministic (true)            = $(Deterministic)" Importance="high" />
    <Message Text="- DeterministicSourcePaths (true) = $(DeterministicSourcePaths)" Importance="high" />
    <Message Text="- EnableSourceLink                = $(EnableSourceLink)" Importance="high" />
    <Message Text="- UseSourceLink (MSBuild-only)    = $(UseSourceLink)" Importance="high" />
    <Message Text="- SourceRoot                      = @(SourceRoot)" Importance="high" />

    <ItemGroup>
      <_LocalTopLevelSourceRoot Include="@(SourceRoot)" Condition="'%(SourceRoot.NestedRoot)' == ''"/>
    </ItemGroup>
  </Target>

</Project>
